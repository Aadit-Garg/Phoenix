{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <!-- Admin Header -->
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-2xl shadow-lg p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold mb-2">Security Command Center</h2>
                <p class="opacity-90">Real-time campus safety monitoring</p>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg p-3">
                <i class="fas fa-shield-alt text-2xl"></i>
            </div>
        </div>
    </div>

    <!-- Emergency Alerts -->
    {% if emergencies %}
    <div class="bg-red-50 border border-red-200 rounded-2xl p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-red-800">
                <i class="fas fa-exclamation-triangle mr-2"></i>Active Emergencies
            </h3>
            <span class="bg-red-500 text-white px-3 py-1 rounded-full text-sm animate-pulse">
                {{ emergencies|length }} Active
            </span>
        </div>

        {% for emergency in emergencies %}
        <div class="bg-white rounded-xl p-4 mb-3 border-l-4 border-red-500">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h4 class="font-bold text-gray-800">{{ emergency.user_name }}</h4>
                    <p class="text-sm text-gray-600">Emergency â€¢ {{ emergency.type|replace('_', ' ')|title }}</p>
                </div>
                <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">Active</span>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-gray-600">Location</p>
                    <p class="font-semibold">Lat: {{ emergency.location.lat|round(4) }}, Lng: {{
                        emergency.location.lng|round(4) }}</p>
                </div>
                <div>
                    <p class="text-gray-600">Time</p>
                    <p class="font-semibold">{{ emergency.timestamp[:16]|replace('T', ' ') }}</p>
                </div>
            </div>
            <div class="flex space-x-2 mt-3">
                <button class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-semibold flex-1">
                    <i class="fas fa-car mr-1"></i>Dispatch
                </button>
                <button class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-semibold flex-1">
                    <i class="fas fa-phone mr-1"></i>Contact
                </button>
                <button class="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-semibold flex-1">
                    <i class="fas fa-check mr-1"></i>Resolve
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Stats Overview -->
    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow-sm p-4 text-center">
            <div class="text-2xl font-bold text-purple-600">{{ stats.total_incidents }}</div>
            <p class="text-sm text-gray-600">Total Incidents</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-4 text-center">
            <div class="text-2xl font-bold text-red-500">{{ stats.active_emergencies }}</div>
            <p class="text-sm text-gray-600">Active Emergencies</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-4 text-center">
            <div class="text-2xl font-bold text-green-500">{{ stats.avg_response_time }}</div>
            <p class="text-sm text-gray-600">Avg Response Time</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-4 text-center">
            <div class="text-2xl font-bold text-blue-500">{{ stats.coverage }}</div>
            <p class="text-sm text-gray-600">Campus Coverage</p>
        </div>
    </div>

    <!-- Patrol Management -->
    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Security Patrols</h3>
        <div class="space-y-3">
            {% for patrol in patrols %}
            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full 
                        {% if patrol.status == 'available' %}bg-green-100 text-green-600
                        {% elif patrol.status == 'patrolling' %}bg-blue-100 text-blue-600
                        {% else %}bg-gray-100 text-gray-600{% endif %} 
                        flex items-center justify-center mr-3">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div>
                        <p class="font-semibold">{{ patrol.name }}</p>
                        <p class="text-sm text-gray-500 capitalize">{{ patrol.status }}</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button class="text-blue-500 hover:text-blue-700"
                        onclick="updatePatrolStatus('{{ patrol.id }}', 'available')">
                        <i class="fas fa-play-circle"></i>
                    </button>
                    <button class="text-green-500 hover:text-green-700"
                        onclick="updatePatrolStatus('{{ patrol.id }}', 'patrolling')">
                        <i class="fas fa-walking"></i>
                    </button>
                    <button class="text-red-500 hover:text-red-700"
                        onclick="updatePatrolStatus('{{ patrol.id }}', 'busy')">
                        <i class="fas fa-pause-circle"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recent Incidents -->
    <div class="bg-white rounded-2xl shadow-sm p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Incidents</h3>
        {% if incidents %}
        <div class="space-y-3">
            {% for incident in incidents|reverse %}
            <div class="border-l-4 
                {% if incident.type == 'harassment' %}border-red-400 bg-red-50
                {% elif incident.type == 'theft' %}border-orange-400 bg-orange-50
                {% else %}border-blue-400 bg-blue-50{% endif %} 
                p-3 rounded-r-lg">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-semibold capitalize">{{ incident.type|replace('_', ' ') }}</p>
                        <p class="text-sm text-gray-600">{{ incident.timestamp[:16]|replace('T', ' ') }}</p>
                    </div>
                    <span class="text-xs px-2 py-1 rounded 
                        {% if incident.type == 'harassment' %}bg-red-100 text-red-800
                        {% elif incident.type == 'theft' %}bg-orange-100 text-orange-800
                        {% else %}bg-blue-100 text-blue-800{% endif %}">
                        {{ incident.safety_rating }}/5 Safety
                    </span>
                </div>
                {% if incident.description %}
                <p class="text-sm text-gray-700 mt-2">{{ incident.description[:100] }}{% if incident.description|length
                    > 100 %}...{% endif %}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-check-circle text-3xl mb-3 text-green-500"></i>
            <p>No recent incidents reported</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function updatePatrolStatus(patrolId, status) {
        fetch('/api/admin/update-patrol', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                patrol_id: patrolId,
                status: status
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Patrol status updated:', data);
                location.reload(); // Simple refresh to update UI
            })
            .catch(error => {
                console.error('Error updating patrol:', error);
            });
    }

    // Auto-refresh emergencies every 10 seconds
    setInterval(() => {
        fetch('/api/admin/emergencies')
            .then(response => response.json())
            .then(emergencies => {
                // In a real app, update the emergencies list dynamically
                if (emergencies.length > 0) {
                    console.log('Active emergencies:', emergencies.length);
                }
            });
    }, 10000);
</script>
{% endblock %}